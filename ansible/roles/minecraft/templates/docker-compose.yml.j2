version: "3.8"

services:
  mc:
    image: itzg/minecraft-server
    tty: true
    stdin_open: true
    ports:
      - "8123:8123"
      - "25565:25565"
      - "19132:19132/udp"
    environment:
      SEED: "2510571545296918609" 
      EULA: "TRUE"
      MEMORY: "4G"
      TYPE: "PAPER"
      VIEW_DISTANCE: 15
      PLUGINS: |
        https://download.geysermc.org/v2/projects/geyser/versions/latest/builds/latest/downloads/spigot
        https://download.geysermc.org/v2/projects/floodgate/versions/latest/builds/latest/downloads/spigot
      SPIGET_RESOURCES: 39965,74429,60623
      FORCE_REDOWNLOAD: "true"
      MOTD: "A Paper Minecraft server hosted in Docker!"
    restart: always
    volumes:
      - /opt/minecraft/world_data:/data

  backups:
    image: itzg/mc-backup
    environment:
      BACKUP_INTERVAL: "2h"
      RCON_HOST: mc
      INITIAL_DELAY: 0
      PRE_BACKUP_SCRIPT: |
        echo "Before backup!"
        echo "Also before backup from $$RCON_HOST to $$DEST_DIR"
      PRUNE_BACKUPS_DAYS: 7
    depends_on:
      mc:
        condition: service_healthy
    volumes:
      # mount the same volume used by server, but read-only
      # use a host attached directory so that it in turn can be backed up
      - /opt/minecraft/world_data:/data 
      - /opt/minecraft/backups:/backups

  cloudflare-ddns-root:
    image: favonia/cloudflare-ddns:latest
    network_mode: host
    restart: always
    security_opt:
      - no-new-privileges:true
    environment:
      - PGID=1000
      - PUID=1000
      - CF_API_TOKEN={{ cloudflare_api_token_dns }}
      - DOMAINS={{ base_domain }}
      - PROXIED=true
      - UPDATE_CRON=@every 60m
      - UPDATE_ON_START=true

  cloudflare-ddns-subdomains:
    image: favonia/cloudflare-ddns:latest
    network_mode: host
    restart: always
    security_opt:
      - no-new-privileges:true
    environment:
      - PGID=1000
      - PUID=1000
      - CF_API_TOKEN={{ cloudflare_api_token_dns }}
      - DOMAINS={{ subdomains }}
      - PROXIED=false
      - UPDATE_CRON=@every 60m
      - UPDATE_ON_START=true